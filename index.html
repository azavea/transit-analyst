<!DOCTYPE html>
<html>
<head>
	<title>Transit Data Analyst</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="css/style.css" />
	<link rel="stylesheet" href="css/otpagraph.css" />
	<link rel="stylesheet" href="css/leaflet.css" />
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <link rel="stylesheet" href="css/Control.Geocoder.css" />
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>
  <script src="js/d3.min.js" charset="utf-8"></script>
  <script src="js/leaflet.utfgrid.js" charset="utf-8"></script>
  <script src="js/OTPAGraph.js" charset="utf-8"></script>
  <script src="js/OTPAGraphBar.js" charset="utf-8"></script>
  <script src="js/Control.Geocoder.js"></script>

  <!--
  <script src="js/OTPAGraphLine.js" charset="utf-8"></script>
  <script src="js/OTPAGraphCircle.js" charset="utf-8"></script>
  <script src="js/OTPAGraphTable.js" charset="utf-8"></script>
  <script src="js/OTPAGraphDensity.js" charset="utf-8"></script>
  -->

  <script src="js/LocationLayer.js"></script>
  <script src="js/OTPALayer.js"></script>
</head>
<body>
  <div id="map"></div>
  <div id="box" class="leaflet-bar">
    <div class="container">
      <h1>Transit Data Analyst <img src="images/ajax-loader.gif" id="spinner"></h1>
      <p></p>
      <h4>Locations reachable within <span id="minutes">30</span> minutes:</h4>
      <table id="options">
        <tr><td>Travel time:</td><td><div id="slider"></div></td>
        <!-- <tr><td>Visualization:</td><td><select id="graph-type"></div></td> -->
        <tr><td>Point set:</td><td><select id="pointsets"></div></td>
        <tr hidden="true"><td>Indicators:</td><td><select id="indicators"></div></td>
      </table>
      <div id="graph"></div>
      <div id="block-info"></div>
    </div>
  </div>
  <div id="info-box" class="leaflet-bar">
    <div class="container">
    <h3>Location Details</h4>
    <div id="info"></div>
  </div>
  <script type="text/template" id="block-template">
    <h4>Census Block <%= geoid10 %></h4>
    <button href="#" id='toggle-travelshed' data-lat="<%= lat %>" data-lng="<%= lng %>">Show Travelshed</button>
    <ul id="bools-list">
    <% _.each(bools, function(item) { %>
      <li class="<%= item.key %> <% if (item.value) { %>active<% } %>" title="<%= item.label %>">
        <%= item.shortLabel %>
      </li>
    <% }); %>
    </ul>
    <ul id="access-list">
        <li><%= label %> Accessibility Percentile : <span class="pull-right"><%= percentile %>%</span></li>
        <li><%= label %> Accessibility Index : <span class="pull-right"><%= index %></span></li>
    </ul>
  </div>
  </script>
  <script type="text/template" id="info-template">
    <h4><%= label %></h4>
    <label><%= description %></label>
  </div>
  </script>
  <script>
    var endpoint = 'http://otp.transitanalyst.com/otp/',
        basemapUrl= 'http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png',
        blockTileBaseUrl = 'http://transitanalyst.com/tiles/';
        range = {
          value: 30,
          min: 1,
          max: 90,
          step: 1
        },
        philly = [39.952671, -75.165475],
        graphTypes = [
          {type: 'bar', label: 'Bar'},
          {type: 'line', label: 'Line'},
          {type: 'circle', label: 'Circle'},
          {type: 'table', label: 'Table'},
          {type: 'density', label: 'Density'}
        ],
        pointset = 'headstart.geo',
        indicator = 'placeholder',
        indicators = {},
        graphType = graphTypes[0].type,
        visWidth = 300,
        otpaGraph = d3.otpaGraph().type(graphType).width(visWidth),

        dataLabels = [
            ['recap_10', 'Is a RECAP neighborhood', 'RECAP'],
            ['promise_neighborhood', 'Is a promise neighborhood', 'PROMISE'],
            ['choice_neighborhood', 'Is a choice neighborhood', 'CHOICE'],
        ],
        datasetLabels = {
            'cornerstores.geo': {
                'percentile': 'cornerstore_access_pct_rank',
                'label': 'Cornerstore',
                'index': 'cornerstore_access'
            },
            'headstart.geo': {
                'percentile': 'headstart_access_pct_rank',
                'label': 'Headstart Center',
                'index': 'headstart_access'
            },
            'healthcare.geo': {
                'percentile': 'healthcare_access_pct_rank',
                'label': 'Health Clinic',
                'index': 'healthcare_access'
            },
            'rec.geo': {
                'percentile': 'rec_access_pct_rank',
                'label': 'Recreation Center',
                'index': 'rec_access'
            },
            'playgrounds.geo': {
                'percentile': 'playground_access_pct_rank',
                'label': 'Playground',
                'index': 'playground_access'
            },
        };

    // Use location hash to specify URL of OTPA endpoint:
    // http://localhost:8080/#192.168.1.103:8080/otp/
    if (location.hash) {
      endpoint = 'http://' + location.hash.slice(1);
    }

    var map = L.map('map').setView(philly, 12);

    L.tileLayer(basemapUrl, {
      maxZoom: 18,
      attribution: 'Maps © Thunderforest, Data © OpenStreetMap contributors'
    }).addTo(map);

    var blockTileLayer = null;
    var gridLayer = null;
    var highlightedPolygon = null;
    var lastHoveredBlockData = null;
    var clickedBlockData = null;
    var clickedPolygon = L.geoJson([], {}).addTo(map);

    var geocoder = L.Control.geocoder({
        position: "topleft",
    }).addTo(map);

    geocoder.markGeocode = function(result) {
        map.setView(result.center, 14);
        if (gridLayer) {
            // Get the object data and call the click event handler,
            // which will highligh the block group for that lat/lng
            var object = gridLayer._objectForEvent({latlng: result.center});
            if (object.data) {
                lastHoveredBlockData = object.data;
                handleHighlightedClick();
            }
        }
    };

    function handleHighlightedClick() {
        clickedBlockData = lastHoveredBlockData;
        clickedPolygon.clearLayers();
        clickedPolygon.addData(JSON.parse(clickedBlockData.geojson));
        updateBlockInfo();
      }

    function updateBlockTiles(pointset) {
      var blockTileUrl = blockTileBaseUrl + pointset + '/{z}/{x}/{y}.png';
      if (blockTileLayer != null) {
        map.removeLayer(blockTileLayer);
      }
      blockTileLayer = L.tileLayer(blockTileUrl);
      map.addLayer(blockTileLayer);

      if (gridLayer != null) {
        map.removeLayer(gridLayer);
      }

      if (highlightedPolygon != null) {
        map.removeLayer(highlightedPolygon);
      }

      highlightedPolygon = L.geoJson([], {}).addTo(map);

      highlightedPolygon.on('click', handleHighlightedClick);

      gridLayer = new L.UtfGrid(blockTileBaseUrl + pointset + '/{z}/{x}/{y}.grid.json', {useJsonP: false});
      gridLayer.on('mouseover', function(e) {
        lastHoveredBlockData = e.data;
        var geojson = JSON.parse(e.data.geojson);
        highlightedPolygon.clearLayers();
        highlightedPolygon.addData(geojson);
      });
      map.addLayer(gridLayer);
    }

    function updateBlockInfo() {
      if (clickedBlockData) {
        var data = [];
        var bools = [];
        var center = clickedPolygon.getBounds().getCenter();

        _.each(dataLabels, function(item) {
          var itemValue = clickedBlockData[item[0]];
          bools.push({
              key: item[0],
              label: item[1],
              shortLabel: item[2],
              value: itemValue
          });
        });

        var pointsetLabels = datasetLabels[pointset];

        $('#block-info').html(blockTemplate({
          geoid10: clickedBlockData.geoid10,
          lat: center.lat,
          lng: center.lng,
          bools: bools,
          label: pointsetLabels.label,
          index: clickedBlockData[pointsetLabels.index],
          percentile: clickedBlockData[pointsetLabels.percentile],
        }));
      }
    }

    updateBlockTiles(pointset);

    d3.select('#slider').append('input')
      .attr('type', 'range')
      .attr('min', range.min)
      .attr('max', range.max)
      .attr('step', range.step)
      .attr('value', range.value)
      .on("input", function() {
        var value = d3.select(this).property('value');
        range.value = value;
        d3.select('#minutes').html(value); // replace span with # of minutes

        // update the graph immediately
        update(indicators, value * 60);

        // tell the layer about the change
        otpaLayer.updateTime(value);
      });

    d3.select('#graph-type').selectAll('option')
        .data(graphTypes).enter()
      .append('option')
        .attr('value', function(d) { return d.type; })
        .html(function(d) { return d.label; });

    d3.select('#graph-type').on("change", function() {
      graphType = d3.event.target.value;
      d3.select('#graph').selectAll('.otpa-graph').remove();
      otpaGraph = d3.otpaGraph().type(graphType).width(visWidth);
      update(indicators, range.value * 60);
    });

    d3.select('#pointsets').on("change", function() {
      pointset = d3.event.target.value;
      otpaLayer.setPointset(pointset);
      update(indicators, range.value * 60);
      updateBlockTiles(pointset);
      updateBlockInfo();
    });

    d3.select('#indicators').on("change", function() {
      indicator = d3.event.target.value;
      d3.select('#graph').selectAll('.otpa-graph').remove();
      update(indicators, range.value * 60);
    });

    var infoTemplate = _.template($("#info-template").html());
    var blockTemplate = _.template($("#block-template").html());

    // // TODO: make sure order of on() and addTo() does not matter
    var otpaLayer = L.otpaLayer(endpoint, {
        cutoffMinutes: range.max,
        isochroneMinutes: range.value,
        spinner: '#spinner',
        pointset: pointset,
        location: philly
      }).on('pointsets', function(e) {
        d3.select('#pointsets').selectAll('option')
            .data(e.data).enter()
          .append('option')
            .attr('value', function(d) { return d.id; })
            .html(function(d) { return datasetLabels[d.id].label + "s"; });
      }).on('change', function(e) {
        indicators = e.data;
        var indicatorKeys;
        if (indicators) {
          indicatorKeys = Object.keys(indicators.data);
        }
        var options = d3.select('#indicators').selectAll('option')
          .data(indicatorKeys, function(d) { return d; })
        options.enter()
          .append('option')
            .attr('value', function(d) { return d; })
            .html(function(d) { return d; });
        options.exit().remove();

        indicator = d3.select('#indicators').property('value');

        d3.select('#graph').selectAll('.otpa-graph').remove();
        update(indicators, range.value * 60);
      }).on('select', function(e) {
          var selectedIndicator = d3.select('#indicators').property('value');
          $('#info').html(infoTemplate({
            label: e.data.label,
            description: e.data.description,
            indicator: selectedIndicator,
            value: e.data.structured[selectedIndicator]
          }));
      }).on('unselect', function(e) {
          $('#info').html('');
          // make sure initally displayed selection matches start value
          d3.select('#pointsets').property('value', pointset);
    }).addTo(map);

    var isochroneShowing = false;
    $('#block-info').on('click', '#toggle-travelshed', function(e) {
        e.preventDefault();
        if (!isochroneShowing) {
          var loc = L.latLng(e.target.dataset.lat, e.target.dataset.lng);
          otpaLayer.setLocation(loc);
          otpaLayer.showIsochrone(true);
          map.removeLayer(gridLayer);
          highlightedPolygon.clearLayers();
          $('#isochrone-details').show();
          $('#toggle-travelshed').text('Hide Travelshed');
        } else {
          otpaLayer.showIsochrone(false);
          map.addLayer(gridLayer);
          $('#isochrone-details').hide();
          $('#toggle-travelshed').text('Show Travelshed');
        }
        isochroneShowing = !isochroneShowing;
    });

    // update() calls otpaGraph with a DOM selection as a parameter.
    // otpaGraph chains the call through to a specific graph type.
    var attributes = {};
    function update(data, seconds) {

      var attributes = {};
      if (data && data.data) {
        attributes['Locations accessible'] = data.data[indicator].counts;
      }

      d3.select('#graph').selectAll('.otpa-graph')
          .data([{seconds: seconds, attributes: attributes}])
          .call(otpaGraph);
   }

  </script>
</body>
</html>
